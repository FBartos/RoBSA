---
title:        "README"
bibliography: inst/REFERENCES.bib
csl:          inst/apa.csl
output:       github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment  = "#>",
  fig.path = "man/figures/README-",
  dev      = "png"
)
if(.Platform$OS.type == "windows"){
  knitr::opts_chunk$set(dev.args = list(type = "cairo"))
}
# we pre-load the model, the fitting time is around 5 minutes
fit.test <- readRDS(file = "models/README/fit.test.RDS")
fit.est  <- readRDS(file = "models/README/fit.est.RDS")
predicted_standard     <- readRDS(file = "models/README/predicted_standard.RDS")
predicted_experimental <- readRDS(file = "models/README/predicted_experimental.test.RDS")
```


# Robust Bayesian Survival Analysis (RoBSA)

This package estimates an ensemble of parametric survival models (with different parametric families) and uses Bayesian model averaging to combine them. The RoBSA ensemble uses Bayes factors to test for the presence or absence of effects of the individual predictors and evaluates the support for each parametric family. The resulting model-averaged parameter estimates are based on posterior model probabilities. The user can define a wide range of prior distributions for the effect size, intercepts, and auxiliary parameters. The package provides convenient functions for summary, visualizations, and fit diagnostics.

See our pre-print @bartos2021informed (https://arxiv.org/abs/2112.08311) introducing the methodology.

## Installation

The package requires [JAGS 4.3.0](https://mcmc-jags.sourceforge.io/) to be installed. The development version of the package can be installed from GitHub:

``` r
devtools::install_github("fbartos/RoBSA")
```

## Example

To illustrate the functionality of the package, we use the `survival::veteran` data set, containing 137 survival times of patients from a randomized trial of two treatment regimens for lung cancer. We start by loading the packages and data set.

```{r}
library("survival")
library("RoBSA")

head(veteran)
```

Before we fit the RoBSA ensemble with five accelerated failure times parametric families (exponential, Weibull, log-normal, log-logistic, and gamma), we must specify prior distributions for the intercepts and auxiliary parameters (governing the scales and shapes) of the competing parametric families. Here, we assume that we would expect the median survival type in the standard treatment group to be 5 years with the interquartile range of 10 years and the standard deviation of 0.5 for the prior distributions (quantifying our uncertainty). To obtain those priors, we use the `calibrate_quartiles()` function and print the list object containing priors for the intercepts and auxiliary parameters.

```{r}
priors <- calibrate_quartiles(median_t = 5, iq_range_t = 10, prior_sd = 0.5)
priors
```

We create new data.frame object containing a fit ready data set. We (1) transform the survival times to years, (2) dummy code the treatment variable, so 0 corresponds to the standard treatment and 1 to the test treatment (i.e., the intercept of the model corresponds to the standard treatment and the treatment estimate to the improvement in the test treatment), and (3) scale the Karnofsky performance score (karno) to range from 0-1 (i.e., the coefficient estimate corresponds to the biggest possible difference).

```{r}
df <- data.frame(
  time            = veteran$time / 12,
  status          = veteran$status,
  treatment_dummy = as.numeric(veteran$trt == 2),
  karno_scaled    = veteran$karno / 100 
)
head(df)
```

### Hypothesis Testing 

We proceed by specifying a RoBSA model intended to test an informed hypothesis of the presence of the treatment effect centered around the log(AF) of 0.3 with the sd of 0.1,5 via the informed prior distribution $\text{Normal}_+(0.30, 0.15)$ on the dummy coded treatment effect. Furthermore, we adjust for the Karnofsky performance score by setting a wider centered standard normal prior distribution $\text{Normal}(0, 1)$. To only test for the presence of the treatment effect and include the covariate in all models, we set `test_predictors = "treatment_dummy"`. Finally, we pass the appropriate prior distributions to the `priors`, `prior_intercept`, and `prior_aux` arguments.

```r
fit.test <- RoBSA(
  Surv(time, status) ~ treatment_dummy + karno_scaled,
  data   = df,
  priors = list(
    treatment_dummy = prior("normal", parameters = list(0.30, 0.15), truncation = list(0, Inf)),
    karno_scaled    = prior("normal", parameters = list(0, 1))
  ),
  test_predictors = "treatment_dummy",
  prior_intercept = priors[["intercept"]],
  prior_aux       = priors[["aux"]]
) 
```

The `summary()` functions provides the main summary of the fitted model.

```{r}
summary(fit.test)
```

In the first table, we see that most posterior model probability is retained by the log-logistic (0.499), exponential (0.322), and log-normal (0.149) family, with the inclusion Bayes factors quantifying the change from prior to posterior model probabilities.

The second table then summarizes the model-averaged coefficient estimates. Here, in the RoBSA ensemble intended for testing, we are primary interested in the inclusion Bayes factor for the treatment effect. We find Bayes factor 0.147, indicating that there is moderate evidence in favor of no treatment effect (1/0.147 = 6.8) in comparison to our informed hypothesis of a positive treatment effect.

### Parameter Estimation

Now we try to estimate the model-averaged estimate of the difference between the two treatments. To do that, we change the prior distribution from the informed positive treatment effect to a neutral standard normal prior distribution allowing for both positive and negative treatment effect. We further set `test_predictors` to `""` in order to omit models assuming zero treatment effect.

```r
fit.est <- RoBSA(
  Surv(time, status) ~ treatment_dummy + karno_scaled,
  data   = df,
  priors = list(
    treatment_dummy = prior("normal", parameters = list(0, 1)),
    karno_scaled    = prior("normal", parameters = list(0, 1))
  ),
  test_predictors = "",
  prior_intercept = priors[["intercept"]],
  prior_aux       = priors[["aux"]]
) 
```

```{r}
summary(fit.est)
```

We again use the `summary()` function to obtain information about the fitted model. We find out that the experimental treatment actually led to notably shorter survival times with the mean model-averaged log(AF) = -0.18, 95% CI[-0.56, -0.18]. Furthermore, we observe an enormous effect of the scaled Karnofsky performance score, showing that moving from 0 to 1 increases the survival times with the mean model-averaged log(AF) = 2.54, 95% CI [1.74, 3.31].

### MCMC Diagnostics

To assess the convergence of the MCMC model, we can use the `diagnostics = TRUE` argument in the `summary()` function. The resulting table shows the maximum MCMC error, min effective sample size and maximum R-hat for each of the models.

```{r}
summary(fit.est, diagnostics = TRUE)
```

We find that while the R-hat and max MCMC error is satisfactory for all models from the RoBSA estimation ensemble, we might wish for a larger ESS. To achieve that, we would simply increase the number of sampling MCMC iterations by using the `iter` argument in the `RoBSA()` function.

### Visualizing Predicted Survival

To visualize the predicted model-averaged survival for each group, we first need to create data.frame specifying the values for which we want to predict the survival. Here, we create a monthly based prediction for the first 20 years for the standard treatment (`df_standard`) and the experimental treatment (`df_experimental`) for the median level of the Karnofsky performance score.

```{r}
df_standard <- data.frame(
  time            = seq(0, 20*12, 1) / 12,
  treatment_dummy = 0,
  karno_scaled    = median(df$karno_scaled)
)

df_experimental <- data.frame(
  time            = seq(0, 20*12, 1) / 12,
  treatment_dummy = 1,
  karno_scaled    = median(df$karno_scaled)
)
```

Then we predict the model-averaged survival with the `predict()` function for each group.

```r
predicted_standard     <- predict(fit.est, newdata = df_standard,     type = "survival")
predicted_experimental <- predict(fit.est, newdata = df_experimental, type = "survival")
```

Now, we can plot the predicted model-averaged survivals and 95% CI for both groups.

```{r predicted_surival, out.width = "80%", fig.align = "center"}
plot(NA, type = "n", xlim = c(0, 20), ylim = c(0, 1), xlab = "Time (Years)", ylab = "Survival", las = 1, bty = "n")
# standard treatment group
lines(seq(0, 20*12, 1) / 12, predicted_standard$mean, col = "blue", lwd = 2)
polygon(
  x   = c(seq(0, 20*12, 1) / 12, rev(seq(0, 20*12, 1) / 12)),
  y   = c(predicted_standard$lCI, rev(predicted_standard$uCI)),
  col = "#0000FF33"
)

# experimental treatment group
lines(seq(0, 20*12, 1) / 12, predicted_experimental$mean, col = "red", lwd = 2)
polygon(
  x   = c(seq(0, 20*12, 1) / 12, rev(seq(0, 20*12, 1) / 12)),
  y   = c(predicted_experimental$lCI, rev(predicted_experimental$uCI)),
  col = "#FF000033"
)
```


### References
